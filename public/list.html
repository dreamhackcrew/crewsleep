<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content = "width = device-width, initial-scale = 1, user-scalable = no" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <title>list</title>
    <link rel="stylesheet" href="/style/style.css" type="text/css" media="screen" title="no title" charset="utf-8">
    <style type="text/css" media="screen">
      body{

      }
      .box.normal{
        width: 320px;
      }
      .poke {
        font-size: 1em;
      }
      h2,h3{
        padding: 0;
        margin: 0;
      }
      .list{
        padding-bottom: 30px;
      }
      .item button{
        height: 100%;
      }
      
      #alarm-list{
        padding: 0 10px 0 10px;
        width: 90%;
      }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.0/jquery.min.js" type="text/javascript" charset="utf-8"></script>
    <script type="text/javascript" charset="utf-8">
      var List;
      var retryList = [];
      
      $.fn.flash = function(func) {
        console.log("yo");
        var b = $(this)
        b.animate({opacity:0.01}, "fast", function(){if(func)func();b.animate({opacity:1}, "fast")});
      }
      
      function runRetry () {
        var f = retryList.pop()
        f()
        if(retryList.length > 0)
          setTimeout("runRetry()", 1000)
      }
      
      function retry (func) {
        retryList.push(func)
        setTimeout("runRetry()", 3000)
      }
      
      function poke (alarm) {
        var id = alarm.data("alarm")
        alarm.addClass("loading")
        $.ajax({
          url: "/api/v1/poke",
          type: 'post',
          data: {alarm:id},
          success: function(data) {
            alarm.find(".pokes").html(data)
            alarm.removeClass("loading")
          },
          error: function() {
            console.log("fail")
            retry(function() {poke(alarm)})
          }
        })
      }
      
      function find_alarm (id) {
        return $("[data-alarm='" + id + "']").closest()
      }
      
      function poll () {
        $.ajax({
          url: "/api/v2/fetch_active_alarms",
          success: function(data) {
            var all_items = {}
            $.each(data, function() {
              var time = this.time
              var list = List.find_list(time)
              if(!list) list = List.add_list(time)
              $.each(this.sections, function() {
                var name = this.name
                var section = List.find_section(list, name)
                if(!section) section = List.add_section(list, name)
                $.each(this.items, function() {
                  all_items[this.id] = true
                  var item = List.find_item(section, this.id)
                  if(item) List.update_item(item, this.place, this.pokes)
                  if(!item) item = List.add_item(section, this.name, this.place, this.pokes, this.id)
                  item.find(".poke").unbind("click").click(function() {
                    poke($(this));
                  })
                })
              })
            });
            //remove old items
            $("[data-alarm]").each(function() {
              var id = $(this).attr("data-alarm")
              if(!all_items[id]){
                $(this).closest(".item").slideUp("fast")
              }
            })
          },
          error: function() {
            alert("error")
          }
        })
      }

      $(function() {
        
        List = {
          lists: $(".lists"),
          t_item: $(".list .section .item").remove().clone(),
          t_section: $(".list .section").remove().clone(),
          t_list: $(".list").remove().clone(),

          add_list: function(text) {
            var list = this.t_list.clone();
            list.find("h2").html(text)
            this.lists.append(list);
            return list;
          },
          add_section: function(list, text) {
            var section = this.t_section.clone();
            section.find("h3").html(text)
            list.append(section)
            return section;
          },
          add_item: function(section, name, place, pokes, id) {
            var item = this.t_item.clone();
            item.find(".name").html(name)
            item.find(".pokes").html(pokes)
            item.find(".place").html(place)
            item.find(".poke").attr("data-alarm", id)
            section.append(item)
            return item
          },
          update_item: function(item, place, pokes) {
            item.find(".pokes").html(pokes)
            item.find(".place").html(place)
          },
          clear: function() {
            this.lists.find(".list").remove()
          },
          find_list: function(text) {
            var r = undefined;
            this.lists.find(".list h2").each(function() {
              if($(this).text() == text) { r = $(this).closest(".list"); return; }
            });
            return r;
          },
          find_section: function(list, text) {
            if(!list) console.error("No list")
            var r = undefined;
            list.find(".section h3").each(function() {
              if($(this).text() == text) { r = $(this).closest(".section"); return; }
            });
            return r;
          },
          find_item: function(section, alarm_id) {
            if(!section) console.error("No list")
            var r = section.find("[data-alarm='" + alarm_id + "']").closest(".item")
            if(r.length == 0) return undefined;
            return r;
          }
        };
        
        
        $(".poke").unbind("click").click(function() {
          var alarm = $(this).attr("data-alarm");
          console.log("poke", alarm)
          poke(alarm);
          
        })
        
        //$("#reload").click(function() {document.location.reload()})
        $("#reload").click(poll)
        
        poll(true);
      })
      

    </script>
  </head>
  <button id="reload">reload</button>
  <div class="lists box normal" id="alarm-list">
    <div class="list">
      <h2>21:00</h1>
      <div class="section">
        <h3>Main</h2>
        <div class="item">
          <span class="place">1-1</span>
          <span class="name">JÃ¶rgen</span>
          <span class="actions">
            <button class="poke" data-alarm="123"><span class="pokes">0</span></button>
          </span>
        </div>
      </div>
    </div>
  </div>
</html>

